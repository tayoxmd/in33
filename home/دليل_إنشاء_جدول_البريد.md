# دليل إنشاء جدول البريد في Supabase

## المشكلة
الخطأ: **"جدول البريد غير موجود. يرجى إنشاء الجدول من إعدادات Supabase"**

هذا يعني أن جدول `emails` غير موجود في قاعدة البيانات Supabase.

## الحل: إنشاء الجدول في Supabase

### الخطوات بالتفصيل:

#### 1. افتح Supabase Dashboard
- اذهب إلى: **https://supabase.com/dashboard**
- سجّل الدخول إلى حسابك
- اختر مشروعك

#### 2. افتح SQL Editor
- من القائمة الجانبية اليسرى، انقر على **"SQL Editor"** (محرر SQL)
- انقر على **"New query"** (استعلام جديد) لإنشاء استعلام جديد

#### 3. انسخ والصق الكود التالي:

```sql
-- Create emails table if not exists
CREATE TABLE IF NOT EXISTS public.emails (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  account_id TEXT NOT NULL,
  from_email TEXT NOT NULL,
  to_email TEXT NOT NULL,
  subject TEXT NOT NULL,
  body TEXT NOT NULL,
  folder TEXT NOT NULL DEFAULT 'inbox' CHECK (folder IN ('inbox', 'sent', 'drafts', 'trash', 'archive', 'spam')),
  read BOOLEAN DEFAULT false,
  starred BOOLEAN DEFAULT false,
  filter_ids JSONB DEFAULT '[]'::jsonb,
  is_archived BOOLEAN DEFAULT false,
  attachments JSONB DEFAULT '[]'::jsonb,
  date TIMESTAMP WITH TIME ZONE DEFAULT now(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Enable RLS on emails
ALTER TABLE public.emails ENABLE ROW LEVEL SECURITY;

-- Drop existing policy if exists and create new one
DROP POLICY IF EXISTS "Users can manage their emails" ON public.emails;
CREATE POLICY "Users can manage their emails"
  ON public.emails
  FOR ALL
  USING (true);

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_emails_account_id ON public.emails(account_id);
CREATE INDEX IF NOT EXISTS idx_emails_folder ON public.emails(folder);
CREATE INDEX IF NOT EXISTS idx_emails_date ON public.emails(date DESC);

COMMENT ON TABLE public.emails IS 'البريد الإلكتروني المحفوظ';
```

#### 4. شغّل الاستعلام
- انقر على زر **"Run"** (تشغيل) في الأسفل
- أو اضغط **`Ctrl+Enter`**
- يجب أن ترى رسالة نجاح في الأسفل

#### 5. تحقق من الجدول
- من القائمة الجانبية، انقر على **"Table Editor"** (محرر الجداول)
- يجب أن ترى جدول **`emails`** في القائمة

#### 6. أعد تحميل صفحة البريد
- ارجع إلى المتصفح
- اضغط **`Ctrl+Shift+R`** لمسح الكاش وإعادة التحميل
- يجب أن تختفي رسالة الخطأ

## طريقة بديلة: استخدام ملف SQL

إذا كنت تفضل استخدام ملف SQL مباشرة:

1. افتح ملف `home/create_emails_table.sql`
2. انسخ المحتوى بالكامل
3. الصقه في SQL Editor في Supabase
4. شغّل الاستعلام

## استكشاف الأخطاء

### إذا ظهر خطأ "permission denied":
- تأكد من أنك مسجل الدخول كـ **admin** في Supabase
- تأكد من أن لديك صلاحيات إنشاء الجداول

### إذا ظهر خطأ "table already exists":
- لا تقلق، هذا يعني أن الجدول موجود بالفعل
- أعد تحميل الصفحة وتحقق من عملها

### إذا استمرت المشكلة:
1. تحقق من Console في المتصفح (F12) للأخطاء
2. تحقق من Supabase Dashboard > Logs للأخطاء
3. تأكد من نسخ الكود بالكامل بدون أخطاء

## بعد إنشاء الجدول

✅ يجب أن تعمل صفحة البريد بشكل طبيعي
✅ يجب أن يعمل نظام السحب والإفلات
✅ يجب أن يعمل نظام التصفية
✅ يجب أن يعمل إرسال البريد

## ملاحظات مهمة

- **RLS (Row Level Security):** الجدول مفعّل عليه RLS، لكن السياسة الحالية تسمح لجميع المستخدمين بالوصول
- **الفهارس:** تم إنشاء فهارس على `account_id` و `folder` و `date` لتحسين الأداء
- **البيانات:** الجدول فارغ في البداية، سيتم ملؤه عند إرسال أو استقبال البريد

---

**ملف SQL موجود في:** `home/create_emails_table.sql`


